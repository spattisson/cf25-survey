
<!DOCTYPE html>
<!-- version 1.3 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽª CF25 Feedback Survey</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2AA27C;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .brand{
            padding: 30px;
            text-align: center;
            padding-bottom: 30px;
        }

        .header {
            background: #667eea;
            padding-top: 30px;
            padding-bottom: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .content {
            padding: 30px;
        }

        .site-footer{
            padding: 30px;
            text-align: center;
            line-height: 2.5;
            font-family: 'din-condensed', sans-serif;
            font-weight: 400;
            font-style: normal;
            letter-spacing: 1px;
            color: #fff;
            text-transform: uppercase;
            font-size: 12px;
        }

        .menu-links{
            padding-right: 30px;
        }

        ul li {
            list-style-type: none;
        }

        a{
            color: white;
        }
        .category-select {
            margin-bottom: 30px;
        }

        .category-select label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .category-select select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            transition: all 0.3s ease;
        }

        .category-select select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .question-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .question-group h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
        }

        .rating-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .rating-group label {
            font-weight: 500;
            color: #555;
            min-width: 200px;
        }

        .rating-stars {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star:hover,
        .star.active {
            color: #ffd93d;
            transform: scale(1.1);
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: #2AA27C;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .results-section, .admin-section, .admin-login-form {
            display: none;
            padding: 30px;
            background: white;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .feedback-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .feedback-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f0f0f0;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .text-center {
            text-align: center;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #fcc;
        }

        .success-message {
            background: #efe;
            color: #363;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #cfc;
        }
    </style>
</head>
<body>
<div class="brand">
        <p><img width="150" height="43" src="https://cedarwoodfestival.com/wp-content/uploads/2019/01/logo.png" alt="Cedarwood Festival logo"></p>
</div>
<div class="container">
    <div class="header">

        <h1>CF25 Feedback Survey</h1>
        <p>Help us make next year's festival even better!</p>
    </div>

    <!-- Main Survey Section -->
    <div class="content" id="surveySection">
        <div class="category-select">
            <label for="attendeeCategory">What best describes you as a festival attendee?</label>
            <select id="attendeeCategory" onchange="updateQuestions()">
                <option value="">Select your category...</option>
                <option value="first-time">First-Time Attendee</option>
                <option value="returning">Returning Attendee</option>
                <option value="guest">Guest (Free Ticket Holder)</option>
                <option value="speaker">Speaker/Artist</option>
                <option value="exhibitor">Marketplace Exhibitor</option>
                <option value="vendor">Food Vendor/Partner/Supplier</option>
                <option value="volunteer">Volunteer/TRIBE member</option>
                <option value="local">Local Resident</option>
            </select>
        </div>

        <div id="questionsContainer" class="hidden">
            <!-- Questions will be populated here -->
        </div>

        <div class="text-center hidden" id="submitSection">
            <button class="btn" onclick="submitSurvey()">Submit Survey</button>
        </div>

        <div id="surveyMessage"></div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">Overview</div>
            <div class="tab" onclick="showTab('categories')">By Category</div>
            <div class="tab" onclick="showTab('feedback')">Feedback</div>
        </div>

        <div id="overviewTab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div>Total Responses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSatisfaction">0</div>
                    <div>Avg Satisfaction</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recommendationRate">0%</div>
                    <div>Would Recommend</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Overall Satisfaction Distribution</h3>
                <canvas id="satisfactionChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div id="categoriesTab" class="hidden">
            <div class="chart-container">
                <h3>Satisfaction by Attendee Category</h3>
                <canvas id="categoryChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <h3>Category Distribution</h3>
                <canvas id="categoryDistChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div id="feedbackTab" class="hidden">
            <div class="feedback-section">
                <h3>Recent Feedback</h3>
                <div id="feedbackContainer">
                    <!-- Feedback will be populated here -->
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="showSurvey()">Take Another Survey</button>
<!--        <button class="btn" onclick="showAdminPanel()">Admin Panel</button>-->
            <button class="btn" onclick="requestAdminPassword()">Show admin functions</button>
        </div>
    </div>

    <!-- Admin Section -->
    <div class="results-section" id="adminSection">
        <p>Admin only functions</p>
        <button class="btn" onclick="showResults()">Show results</button>
        <button class="btn" onclick="exportData()">Export all data</button>
        <button class="btn" onclick="resetData()">Reset all data</button>
    </div>
    <div class="admin-login-form" id="adminLoginForm">
        <h2>Admin login</h2>
        <label for="adminPassword">Enter password</label>
        <input type="password" id="adminPassword" placeholder="Password" />
        <button class="btn" onclick="validateAdminPassword()">Login</button>
    </div>
</div>

<script>
    // Configuration - Update this with your server details
    const API_BASE_URL = 'php_backend.php'; // Update this to your API endpoint

    let surveyData = [];
    let currentTab = 'overview';
    let isAdminLoggedIn = false;
    let chartInstances = {};

    const questionSets = {
        'first-time': {
            title: 'First-Time Attendee Questions',
            ratings: [
                'How easy was it to find information about the festival?',
                'How clear were the directions and signage?',
                'How welcoming did the staff make you feel?',
                'How well did the festival meet your expectations?',
                'How likely are you to attend next year?'
            ],
            feedback: [
                'What attracted you to attend this festival for the first time?',
                'What was the highlight of your festival experience?',
                'What would you change or improve for next year?',
                'Which church fellowship are you associated with? (optional)'
            ]
        },
        'returning': {
            title: 'Returning Attendee Questions',
            ratings: [
                'How does this year compare to previous years?',
                'How satisfied were you with the lineup/programming?',
                'How well were any previous concerns addressed?',
                'How satisfied were you with new additions this year?',
                'How likely are you to return next year?'
            ],
            feedback: [
                'What keeps bringing you back to this festival?',
                'What improvements have you noticed over the years?',
                'What would make you even more excited for next year?',
                'Which church fellowship are you associated with? (optional)'
            ]
        },
        'guest': {
            title: 'Guest (Free Ticket Holder) Questions',
            ratings: [
                'How satisfied were you with the amenities provided for you?',
                'How comfortable/suitable did the backstage areas feel?',
                'How responsive was the care from the team and other volunteers?',
                'How likely are you to return to CF again?'
            ],
            feedback: [
                'What Guest perks did you value most?',
                'What Guest services or amenities were missing?',
                'How could we enhance the experience for yourself?'
            ]
        },
        'speaker': {
            title: 'Speaker/Artist Questions',
            ratings: [
                'How satisfied were you with the backstage facilities?',
                'How well were you supported by festival staff?',
                'How satisfied were you with sound/technical support?',
                'How well did the audience respond to your performance?',
                'How likely are you to perform at this festival again?'
            ],
            feedback: [
                'What made performing at this festival special?',
                'What challenges did you face as a performer?',
                'What would improve the artist experience?'
            ]
        },
        'exhibitor': {
            title: 'Marketplace Exhibitor Questions',
            ratings: [
                'How satisfied were you with your assigned location?',
                'How well did festival management support exhibitors?',
                'How satisfied were you with foot traffic/sales?',
                'How clear were exhibitor guidelines and communication?',
                'How likely are you to participate as a exhibitors again?'
            ],
            feedback: [
                'What worked well for your exhibitor experience?',
                'What operational challenges did you face?',
                'How could exhibitor support be improved?'
            ]
        },
        'vendor': {
            title: 'Vendor/Staff Questions',
            ratings: [
                'How satisfied were you with your assigned location?',
                'How well did festival management support vendors?',
                'How satisfied were you with footfall/sales?',
                'How clear were vendor guidelines and communication?',
                'How likely are you to participate as a vendor again?'
            ],
            feedback: [
                'What worked well for your vendor experience?',
                'What operational challenges did you face?',
                'How could vendor support be improved?'
            ]
        },
        'volunteer': {
            title: 'Volunteer/TRIBE Member Questions',
            ratings: [
                'How well was your application responded to?',
                'How satisfied were you with your assigned role?',
                'How well did volunteer management support you?',
                'How satisfied were you with your access to food/breaks/festival events?',
                'How clear were volunteer guidelines and communication?',
                'How likely are you to participate as a volunteer again?'
            ],
            feedback: [
                'What worked well for your volunteer experience?',
                'What operational challenges did you face?',
                'How could volunteer support be improved?'
            ]
        },
        'local': {
            title: 'Local Resident Questions',
            ratings: [
                'How well did the festival respect the local community?',
                'How satisfied were you with noise management?',
                'How well were traffic and parking handled?',
                'How positive was the festival\'s impact on your area?',
                'How likely are you to support the festival returning?'
            ],
            feedback: [
                'What positive impacts did you notice in your community?',
                'What concerns do you have about the festival?',
                'How could the festival better serve local residents?',
                'Which church fellowship are you associated with? (optional)'
            ]
        }
    };

    // Utility functions
    function showMessage(elementId, message, type = 'info') {
        const element = document.getElementById(elementId);
        if (!element) return;

        const className = type === 'error' ? 'error-message' : 'success-message';
        element.innerHTML = `<div class="${className}">${message}</div>`;
        setTimeout(() => element.innerHTML = '', 5000);
    }

    function setLoading(buttonId, loading = true) {
        const button = document.getElementById(buttonId);
        if (!button) return;

        if (loading) {
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>' + button.textContent;
        } else {
            button.disabled = false;
            button.innerHTML = button.textContent.replace(/^.*<\/span>/, '');
        }
    }

    // API functions
    async function apiCall(action, data = {}) {
        try {
            const response = await fetch(`${API_BASE_URL}?action=${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('API call failed:', error);
            return { success: false, error: error.message };
        }
    }

    async function loadSurveyData() {
        const result = await apiCall('surveys');
        if (result.success) {
            surveyData = result.data;
            updateCharts();
        } else {
            console.error('Failed to load survey data:', result.error);
        }
    }

    // Survey functions
    function updateQuestions() {
        const category = document.getElementById('attendeeCategory').value;
        const container = document.getElementById('questionsContainer');
        const submitSection = document.getElementById('submitSection');

        if (!category) {
            container.classList.add('hidden');
            submitSection.classList.add('hidden');
            return;
        }

        const questions = questionSets[category];
        let html = `<div class="question-group">
                <h3>${questions.title}</h3>`;

        // Rating questions
        questions.ratings.forEach((question, index) => {
            html += `
                    <div class="rating-group">
                        <label>${question}</label>
                        <div class="rating-stars" data-rating="${category}-rating-${index}">
                            ${[1,2,3,4,5].map(star =>
                `<span class="star" onclick="setRating('${category}-rating-${index}', ${star})">â˜…</span>`
            ).join('')}
                        </div>
                    </div>`;
        });

        html += '</div>';

        // Feedback questions
        questions.feedback.forEach((question, index) => {
            html += `
                    <div class="question-group">
                        <h3>${question}</h3>
                        <textarea id="${category}-feedback-${index}" placeholder="Share your thoughts..."></textarea>
                    </div>`;
        });

        container.innerHTML = html;
        container.classList.remove('hidden');
        submitSection.classList.remove('hidden');
    }

    function setRating(ratingId, value) {
        const stars = document.querySelectorAll(`[data-rating="${ratingId}"] .star`);
        stars.forEach((star, index) => {
            star.classList.toggle('active', index < value);
        });
        stars[0].parentElement.setAttribute('data-value', value);
    }

    async function submitSurvey() {
        const category = document.getElementById('attendeeCategory').value;
        const questions = questionSets[category];

        const response = {
            id: Date.now(),
            category: category,
            timestamp: new Date().toISOString(),
            ratings: {},
            feedback: {}
        };

        // Collect ratings
        questions.ratings.forEach((question, index) => {
            const ratingElement = document.querySelector(`[data-rating="${category}-rating-${index}"]`);
            const value = ratingElement?.getAttribute('data-value') || 0;
            response.ratings[question] = parseInt(value);
        });

        // Collect feedback
        questions.feedback.forEach((question, index) => {
            const textArea = document.getElementById(`${category}-feedback-${index}`);
            response.feedback[question] = textArea?.value || '';
        });

        // Submit to server
        setLoading('submitBtn');
        const result = await apiCall('submit', response);
        setLoading('submitBtn', false);

        if (result.success) {
            showMessage('surveyMessage', 'Thank you! Your survey has been submitted successfully.', 'success');
            setTimeout(() => {
                showResults();
                loadSurveyData();
            }, 2000);
        } else {
            showMessage('surveyMessage', 'Failed to submit survey: ' + result.error, 'error');
        }
    }

    // Navigation functions
    function showResults() {
        document.getElementById('surveySection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('adminSection').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'none';
    }

    function showSurvey() {
        document.getElementById('surveySection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('adminSection').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'none';


        // Reset form
        document.getElementById('attendeeCategory').value = '';
        document.getElementById('questionsContainer').classList.add('hidden');
        document.getElementById('submitSection').classList.add('hidden');
        document.getElementById('surveyMessage').innerHTML = '';
    }

    function showAdminPanel() {
        document.getElementById('surveySection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('adminSection').style.display = 'block';

        // Reset login form if not logged in
        if (!isAdminLoggedIn) {
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('adminControls').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginMessage').innerHTML = '';
        } else {
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('adminControls').classList.remove('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            //updateAdminStats();
        }
    }

    // Admin functions
    function requestAdminPassword() {
        document.getElementById('adminLoginForm').style.display = 'block';
    }

    async function validateAdminPassword() {
        const password = document.getElementById('adminPassword').value;

        setLoading('adminLoginBtn');
        const result = await apiCall('validate_admin', { password });
        setLoading('adminLoginBtn', false);

        if (result.success) {
            isAdminLoggedIn = true;
            document.getElementById('adminSection').classList.remove('hidden');
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('adminControls').classList.remove('hidden');
            showMessage('adminLoginMessage', 'Admin access granted successfully!', 'success');
            updateAdminStats();
            alert('Admin access granted successfully!');
            showAdminPanel()
        } else {
            showMessage('adminLoginMessage', 'Incorrect password. Access denied.', 'error');
            document.getElementById('adminPassword').value = '';
        }
    }

    function adminLogout() {
        isAdminLoggedIn = false;
        //document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'block';
        document.getElementById('adminControls').classList.add('hidden');
        document.getElementById('adminSection').classList.add('hidden');
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminLoginMessage').innerHTML = '';
        document.getElementById('adminMessage').innerHTML = '';
        alert('Logged out successfully.');
    }

    async function changeAdminPassword() {
        const currentPassword = prompt('Enter current admin password:');
        if (!currentPassword) return;

        const newPassword = prompt('Enter new admin password:');
        if (!newPassword || newPassword.length < 6) {
            alert('New password must be at least 6 characters long.');
            return;
        }

        const confirmPassword = prompt('Confirm new password:');
        if (newPassword !== confirmPassword) {
            alert('Passwords do not match.');
            return;
        }

        const result = await apiCall('change_password', {
            current_password: currentPassword,
            new_password: newPassword
        });

        if (result.success) {
            showMessage('adminMessage', 'Admin password changed successfully!', 'success');
        } else {
            showMessage('adminMessage', 'Failed to change password: ' + result.error, 'error');
        }
    }

    async function updateAdminStats() {
        const result = await apiCall('stats');
        if (!result.success) {
            showMessage('adminMessage', 'Failed to load statistics: ' + result.error, 'error');
            return;
        }

        const stats = result.stats;

        // Update stat cards
        const totalEl = document.getElementById('adminTotalResponses');
        const sizeEl = document.getElementById('adminDataSize');
        if (totalEl) totalEl.textContent = stats.totalResponses;
        if (sizeEl) sizeEl.textContent = stats.dataSizeKB;

        // Update quick stats
        const quickStatsEl = document.getElementById('adminQuickStats');
        if (!quickStatsEl) return;

        if (stats.totalResponses === 0) {
            quickStatsEl.innerHTML = '<p style="text-align: center; color: #666;">No survey data available yet.</p>';
            return;
        }

        let statsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
        stats.categoryBreakdown.forEach(cat => {
            const percentage = Math.round((cat.count / stats.totalResponses) * 100);
            const categoryName = cat.category.charAt(0).toUpperCase() + cat.category.slice(1).replace('-', ' ');
            statsHtml += `
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <strong>${categoryName}</strong><br>
                        ${cat.count} responses (${percentage}%)
                    </div>
                `;
        });
        statsHtml += '</div>';

        quickStatsEl.innerHTML = statsHtml;
    }

    async function resetData() {
        if (!confirm('Are you sure you want to reset all survey data? This action cannot be undone.')) {
            return;
        }

        const password = prompt('Enter admin password to confirm:');
        if (!password) return;

        setLoading('resetBtn');
        const result = await apiCall('reset_data', { password });
        setLoading('resetBtn', false);

        if (result.success) {
            showMessage('adminMessage', 'All survey data has been reset successfully.', 'success');
            surveyData = [];
            updateCharts();
            updateAdminStats();
        } else {
            showMessage('adminMessage', 'Failed to reset data: ' + result.error, 'error');
        }
    }

    async function exportData() {
        setLoading('exportBtn');
        const result = await apiCall('surveys');
        setLoading('exportBtn', false);

        if (result.success) {
            const dataStr = JSON.stringify(result.data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'cf25-survey-data.json';
            link.click();
            URL.revokeObjectURL(url);
            showMessage('adminMessage', 'Survey data exported successfully.', 'success');
        } else {
            showMessage('adminMessage', 'Failed to export data: ' + result.error, 'error');
        }
    }

    async function exportSummaryReport() {
        setLoading('exportSummaryBtn');

        // Get fresh stats for report
        const statsResult = await apiCall('stats');
        const surveyResult = await apiCall('surveys');

        setLoading('exportSummaryBtn', false);

        if (!statsResult.success || !surveyResult.success) {
            showMessage('adminMessage', 'Failed to generate report.', 'error');
            return;
        }

        const report = generateSummaryReport(statsResult.stats, surveyResult.data);
        const reportBlob = new Blob([report], {type: 'text/plain'});
        const url = URL.createObjectURL(reportBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'cf25-survey-summary-report.txt';
        link.click();
        URL.revokeObjectURL(url);
        showMessage('adminMessage', 'Summary report exported successfully.', 'success');
    }

    function generateSummaryReport(stats, data) {
        let report = 'CF25 Festival Survey Summary Report\n';
        report += '====================================\n\n';
        report += `Generated: ${new Date().toLocaleString()}\n`;
        report += `Total Responses: ${stats.totalResponses}\n\n`;

        if (stats.totalResponses === 0) {
            report += 'No survey responses available yet.\n';
            return report;
        }

        // Category breakdown
        report += 'RESPONSES BY CATEGORY:\n';
        report += '----------------------\n';
        stats.categoryBreakdown.forEach(cat => {
            const percentage = Math.round((cat.count / stats.totalResponses) * 100);
            const categoryName = cat.category.charAt(0).toUpperCase() + cat.category.slice(1).replace('-', ' ');
            report += `${categoryName}: ${cat.count} responses (${percentage}%)\n`;
        });

        // Overall satisfaction
        report += '\nOVERALL SATISFACTION:\n';
        report += '---------------------\n';
        report += `Average Rating: ${stats.avgSatisfaction}/5.0\n`;
        report += `Recommendation Rate: ${stats.recommendationRate}%\n`;
        report += `Total Ratings: ${stats.totalRatings}\n\n`;

        // Recent feedback highlights
        report += 'RECENT FEEDBACK HIGHLIGHTS:\n';
        report += '---------------------------\n';
        const recentFeedback = data.slice(-5);
        recentFeedback.forEach(response => {
            const categoryName = response.category.charAt(0).toUpperCase() + response.category.slice(1).replace('-', ' ');
            report += `\n${categoryName} Attendee:\n`;
            Object.entries(response.feedback).forEach(([question, answer]) => {
                if (answer && answer.trim()) {
                    report += `  â€¢ ${question}\n    "${answer}"\n`;
                }
            });
        });

        return report;
    }



    // Chart functions
    function showTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // Show/hide tab content
        ['overview', 'categories', 'feedback'].forEach(tab => {
            const tabEl = document.getElementById(tab + 'Tab');
            if (tabEl) {
                tabEl.classList.toggle('hidden', tab !== tabName);
            }
        });

        currentTab = tabName;
    }

    function updateCharts() {
        updateOverviewStats();
        updateSatisfactionChart();
        updateCategoryCharts();
        updateFeedbackDisplay();
    }

    function updateOverviewStats() {
        const totalResponses = surveyData.length;

        let totalSatisfaction = 0;
        let ratingCount = 0;
        let wouldRecommend = 0;

        surveyData.forEach(response => {
            Object.values(response.ratings).forEach(rating => {
                if (rating > 0) {
                    totalSatisfaction += rating;
                    ratingCount++;
                    if (rating >= 4) wouldRecommend++;
                }
            });
        });

        const avgSatisfaction = ratingCount > 0 ? (totalSatisfaction / ratingCount).toFixed(1) : 0;
        const recommendationRate = ratingCount > 0 ? Math.round((wouldRecommend / ratingCount) * 100) : 0;

        const totalEl = document.getElementById('totalResponses');
        const avgEl = document.getElementById('avgSatisfaction');
        const recEl = document.getElementById('recommendationRate');

        if (totalEl) totalEl.textContent = totalResponses;
        if (avgEl) avgEl.textContent = avgSatisfaction + '/5';
        if (recEl) recEl.textContent = recommendationRate + '%';
    }

    function updateSatisfactionChart() {
        const ctx = document.getElementById('satisfactionChart')?.getContext('2d');
        if (!ctx) return;

        // Destroy existing chart
        if (chartInstances.satisfaction) {
            chartInstances.satisfaction.destroy();
        }

        const ratingCounts = [0, 0, 0, 0, 0];
        surveyData.forEach(response => {
            Object.values(response.ratings).forEach(rating => {
                if (rating > 0) ratingCounts[rating - 1]++;
            });
        });

        chartInstances.satisfaction = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                datasets: [{
                    label: 'Number of Ratings',
                    data: ratingCounts,
                    backgroundColor: [
                        '#ff6b6b',
                        '#ffa726',
                        '#ffcc02',
                        '#66bb6a',
                        '#4caf50'
                    ]
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function updateCategoryCharts() {
        updateCategoryRadarChart();
        updateCategoryDistributionChart();
    }

    function updateCategoryRadarChart() {
        const ctx = document.getElementById('categoryChart')?.getContext('2d');
        if (!ctx) return;

        // Destroy existing chart
        if (chartInstances.categoryRadar) {
            chartInstances.categoryRadar.destroy();
        }

        const categoryData = {};

        surveyData.forEach(response => {
            if (!categoryData[response.category]) {
                categoryData[response.category] = { total: 0, count: 0 };
            }

            Object.values(response.ratings).forEach(rating => {
                if (rating > 0) {
                    categoryData[response.category].total += rating;
                    categoryData[response.category].count++;
                }
            });
        });

        const categories = Object.keys(categoryData);
        const avgRatings = categories.map(cat =>
            categoryData[cat].count > 0 ? (categoryData[cat].total / categoryData[cat].count).toFixed(1) : 0
        );

        if (categories.length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('No data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        chartInstances.categoryRadar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: categories.map(cat => cat.charAt(0).toUpperCase() + cat.slice(1).replace('-', ' ')),
                datasets: [{
                    label: 'Average Satisfaction',
                    data: avgRatings,
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 5,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function updateCategoryDistributionChart() {
        const ctx = document.getElementById('categoryDistChart')?.getContext('2d');
        if (!ctx) return;

        // Destroy existing chart
        if (chartInstances.categoryDist) {
            chartInstances.categoryDist.destroy();
        }

        const categoryCounts = {};

        surveyData.forEach(response => {
            categoryCounts[response.category] = (categoryCounts[response.category] || 0) + 1;
        });

        if (Object.keys(categoryCounts).length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('No data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        chartInstances.categoryDist = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(categoryCounts).map(cat =>
                    cat.charAt(0).toUpperCase() + cat.slice(1).replace('-', ' ')
                ),
                datasets: [{
                    data: Object.values(categoryCounts),
                    backgroundColor: [
                        '#ff6b6b',
                        '#4ecdc4',
                        '#45b7d1',
                        '#96ceb4',
                        '#feca57',
                        '#ff9ff3',
                        '#a8e6cf',
                        '#ffd93d'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    function updateFeedbackDisplay() {
        const container = document.getElementById('feedbackContainer');
        if (!container) return;

        if (surveyData.length === 0) {
            container.innerHTML = '<p>No feedback responses yet.</p>';
            return;
        }

        let html = '';
        const recentFeedback = surveyData.slice(-10).reverse();

        recentFeedback.forEach(response => {
            const categoryName = response.category.charAt(0).toUpperCase() + response.category.slice(1).replace('-', ' ');

            Object.entries(response.feedback).forEach(([question, answer]) => {
                if (answer && answer.trim()) {
                    html += `
                            <div class="feedback-item">
                                <strong>${categoryName}:</strong> ${question}
                                <p style="margin-top: 8px; font-style: italic;">"${answer}"</p>
                            </div>
                        `;
                }
            });
        });

        container.innerHTML = html || '<p>No feedback responses yet.</p>';
    }

    // Initialize application
    window.addEventListener('load', () => {
        // Load initial data when viewing results
        if (window.location.hash === '#results') {
            showResults();
        }
    });
</script>

<footer id="footer" role="contentinfo" class="site-footer">

    <div class="footer-bottom">
        <p class="menu-links">
            <a href="http://cedarwoodfestival.com/contact">Contact</a> &nbsp;
            <a href="https://cedarwoodfestival.com/donate/">Donate</a> &nbsp;
            <a href="http://cedarwoodfestival.com/privacy-policy/">Privacy</a> &nbsp;
            <a href="http://cedarwoodfestival.com/terms-and-conditions/">T&amp;C's</a>
        </p>
        <p class="copyright">Â© Cedarwood Festival. All Rights Reserved. Registered Charity No. 518744.</p>

        <p class="social-networks">
            <div class="social-link">
                <a href="https://twitter.com/CedarwoodFest" target="_blank" class="twitter" title="Twitter" aria-label="Twitter" rel="noopener"><i class="fab fa-x-twitter"></i><span class="name">Twitter</span></a>
            </div>
            <div class="social-link">
                <a href="https://www.facebook.com/Cedarwood-Festival-2006166366328320/" target="_blank" class="facebook" title="Facebook" aria-label="Facebook" rel="noopener"><i class="fab fa-facebook"></i><span class="name">Facebook</span></a>
            </div>
            <div class="social-link">
                <a href="https://www.instagram.com/cedarwoodfestival/" target="_blank" class="instagram" title="Instagram" aria-label="Instagram" rel="noopener"><i class="fab fa-instagram"></i><span class="name">Instagram</span></a>
            </div>
            <div class="social-link">
                <a href="https://www.youtube.com/channel/UCY70X1RYM79fCX_-GDwIUyg" target="_blank" class="youtube" title="YouTube" aria-label="YouTube" rel="noopener"><i class="fab fa-youtube"></i><span class="name">YouTube</span></a>
            </div>
            <div class="social-link">
                <a href="https://www.tiktok.com/@cedarwoodfestival?lang=en" target="_blank" class="tiktok" title="TikTok" aria-label="TikTok" rel="noopener"><i class="fab fa-tiktok"></i><span class="name">TikTok</span></a>
            </div>
    </div>
</footer>
</body>
</html>